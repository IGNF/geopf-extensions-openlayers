{{#extend "ol-sample-modules-dsfr-layout"}}

{{#content "vendor"}}

<link rel="stylesheet" href="{{ baseurl }}/dist/modules/GpfExtOlLayerSwitcher.css" />
<script src="{{ baseurl }}/dist/modules/GpfExtOlLayerSwitcher.js"></script>
<script src="{{ baseurl }}/dist/modules/GpfExtOlLayers.js"></script>
{{/content}}

{{#content "head"}}
<title>Sample openlayers LayerSwitcher</title>
{{/content}}

{{#content "style"}}
<style>
    div#map {
        width: 100%;
        height: 500px;
    }
</style>
{{/content}}

{{#content "body"}}
<h2>Ajout du gestionnaire de couches avec formulaire d'ajout de couche</h2>
<!-- map -->
<div id="map">
</div>
<div style="display: flex;flex-direction: column;align-items: center;width: 210px;">
    <button type="button" class="fr-btn" id="addVectorLayer">Ajouter une couche de dessin</button>
    <button type="button" class="fr-btn" id="addMapsLayer">Ajouter une couche Map</button>
    <button type="button" class="fr-btn" id="addOSMLayer">Ajouter une couche OSM</button>
    <button type="button" class="fr-btn" id="addVTLayer">Ajouter une couche Tuiles Vecteur</button>
    <br>
    <button type="button" class="fr-btn" id="modifyVisibilityOSMLayer">Visibilité sur la couche OSM</button>
    <button type="button" class="fr-btn" id="modifyOpacityOSMLayer">Opacité sur la couche OSM</button>
    <button type="button" class="fr-btn" id="modifyIndexOSMLayerMin">Position (-) de la couche OSM</button>
    <button type="button" class="fr-btn" id="modifyIndexOSMLayerMax">Position (+) de la couche OSM</button>
    <label for="producerTextOsm" class="fr-label">Nom producteur couche OSM</label>
    <input type="text" class="fr-input" id="producerTextOsm"></input>
    <button type="button" class="fr-btn" id="validateProducerTextOsm">Valider produceur</button>
</div>
{{/content}}

{{#content "js"}}
<script type="text/javascript">
    var map;
    var layerSwitcher;
    var addMapsLayer, addOSMLayer;
    var osm, maps, ortho;

    var createMap = function () {
        // on cache l'image de chargement du Géoportail.
        document.getElementById('map').style.backgroundImage = 'none';

        osm = new ol.layer.Tile({
            source: new ol.source.OSM(),
            opacity: 0.8,
            producer: '<a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>'
        });
        ortho = new ol.layer.GeoportalWMTS({
            layer: "ORTHOIMAGERY.ORTHOPHOTOS",
            olParams: {
                visible: true,
                opacity: 0.8,
                grayscale: true
            }
        });

        // Création de la map
        map = new ol.Map({
            target: "map",
            view: new ol.View({
                center: [288074.8449901076, 6247982.515792289],
                zoom: 6
            }),
            layers: [
                osm,
                ortho
            ]
        });

        // Appel du LayerSwitcher
        layerSwitcher = new ol.control.LayerSwitcher(
        {
            layers: [
            {
                layer: osm,
                config: {
                    title: 'open street',
                }
            },
            {
                layer: ortho,
                config: {
                    producer : 'IGN',
                }
            }
        ],
            options: {
                position: "top-right",
                collapsed: false,
                panel: true,
                counter: true,
                // allowDraggable: false,
                // allowTooltips: true,
                allowDelete: true,
                headerButtons: [
                    {
                        label: 'Ajouter',
                        title: 'Ajouter une couche',
                        icon: "fr-icon-add-line",
                        cb: (e, switcher) => { console.log(e, switcher); },
                    },
                    {
                        label: 'Créer un groupe',
                        icon: "fr-icon-folder-2-line",
                        cb: (e, switcher) => { console.log(e, switcher); },
                    },
                ],
                advancedTools: [
                    // cas nominal : SVG inline
                    {
                        label: 'One',
                        icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#000091"><path d="M7.24264 17.9967H3V13.754L14.435 2.319C14.8256 1.92848 15.4587 1.92848 15.8492 2.319L18.6777 5.14743C19.0682 5.53795 19.0682 6.17112 18.6777 6.56164L7.24264 17.9967ZM3 19.9967H21V21.9967H3V19.9967Z"></path></svg>',
                        cb: (e, instance, layer, options) => {
                            console.log(e, instance, layer, options);
                        }
                    },
                    // icone par defaut
                    {
                        label: 'Two',
                        cb: (e, instance, layer, options) => {
                            console.log(e, instance, layer, options);
                        }
                    },
                    // cas nominal : URL
                    {
                        label: 'Three',
                        icon: '{{ resources }}/data/recherche-avancee.svg',
                        cb: () => window.history.back()
                    },
                    // notification via abonnement
                    {
                        label: 'Four',
                        icon: '<svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.66667 15.3333L6 12.6667H11.3333L8.66667 15.3333ZM8.66667 2L11.3333 4.66667H6L8.66667 2ZM8.66667 10C7.93027 10 7.33333 9.40307 7.33333 8.66667C7.33333 7.93027 7.93027 7.33333 8.66667 7.33333C9.40307 7.33333 10 7.93027 10 8.66667C10 9.40307 9.40307 10 8.66667 10ZM2 8.66667L4.66667 6V11.3333L2 8.66667ZM15.3333 8.66667L12.6667 11.3333V6L15.3333 8.66667Z" fill="#000091"/></svg>',
                    },
                    {
                        label: 'Five',
                        icon: 'fr-icon-bug-fill'
                    },
                ]
            }
        });


        // let layerSwitcher = new ol.control.LayerSwitcher({
        //     layers: [{
        //         layer: wms1,
        //         config: {
        //             title: "Titre layer ",
        //             description: "description layer 1",
        //             picto: "url",
        //             producer: "Producteur",
        //         }
        //     }],
        //     options: {
        //         collapsed: true,
        //         panel: false,
        //         counter: false,
        //         position: "top-right",
        //         allowEdit: true,
        //         allowGrayScale: true,
        //         headerButtons: [
        //             {
        //                 label: 'Bouton',
        //                 title: 'Titre bouton',
        //                 icon: "svg | http | className",
        //                 cb: (e, LayerSwitcher, options) => { },
        //             }
        //         ],
        //         removeLayer: true,
        //         advancedTools: [
        //             {
        //                 // Static value
        //                 tool: ol.control.LayerSwitcher.recenter,
        //                 layerTypes: [ol.layer]
        //             },
        //             {
        //                 // Static value
        //                 tool: ol.control.LayerSwitcher.info,
        //                 layerTypes: [ol.layer]
        //             },
        //             {
        //                 tool: ol.control.LayerSwitcher.info,
        //                 layerTypes: [ol.layer]
        //             },
        //             {
        //                 label: 'Bouton',
        //                 icon: "svg | http",
        //                 cb: (e, LayerSwitcher, layer, options) => { },
        //                 layerTypes: [ol.layer]
        //             }
        //         ]
        //     }
        // });

        // Evenement
        layerSwitcher.on("layerswitcher:add", function (e) {
            console.warn("layer", e, e.layer);
        });
        layerSwitcher.on("layerswitcher:remove", function (e) {
            console.warn("layer", e, e.layer);
        });
        layerSwitcher.on("layerswitcher:change:opacity", function (e) {
            console.warn("layer", e, e.layer, e.opacity);
        });
        layerSwitcher.on("layerswitcher:change:visibility", function (e) {
            console.warn("layer", e, e.layer, e.visibility);
        });
        layerSwitcher.on("layerswitcher:change:grayscale", function (e) {
            console.warn("layer", e, e.layer, e.grayscale);
        });
        layerSwitcher.on("layerswitcher:extent", function (e) {
            console.warn("layer", e);
        });

        // Ajout du LayerSwitcher à la carte
        map.addControl(layerSwitcher);
    };

    Gp.Services.getConfig({
        customConfigFile: "{{ configurl }}",
        callbackSuffix: "",
        // apiKey: "{{ apikey }}",
        timeOut: 20000,
        onSuccess: createMap,
        onFailure: (e) => {
            console.log(e)
            console.error(e.stack)
        }
    });

    addVectorLayer = function () {
        let vector = new ol.layer.Vector({
            source: new ol.source.Vector(),
            title: 'Dessin',
            producer: 'Moi'
        });
        map.addLayer(vector);
    };

    addMapsLayer = function () {
        maps = new ol.layer.Tile({
            source: new ol.source.GeoportalWMTS({
                layer: "GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2"
            }), // , zIndex : 0
            grayscale: true
        });
        map.addLayer(maps);
    };

    addOSMLayer = function () {
        osm = new ol.layer.Tile({
            source: new ol.source.OSM(),
            // zIndex : 4,
            opacity: 0.5,
            producer: 'Open Street Map'
        });
        map.addLayer(osm); // pas d'autoconf sur une couche utilisateur donc description et nom par defaut !
    };
    addVTLayer = function () {
        layer = new ol.layer.GeoportalMapBox({
            layer: "PLAN.IGN",
            style: "standard"
        }, {
            visible: true,
            opacity: 0.8,
            grayscale: true
        });
        map.addLayer(layer); // pas d'autoconf sur une couche utilisateur donc description et nom par defaut !
    };
    modifyVisibilityOSMLayer = function () {
        var visibility = osm.getVisible();
        osm.setVisible(!visibility);
    };
    modifyOpacityOSMLayer = function () {
        var opacity = (osm.getOpacity() === 1.0) ? 0.5 : 1.0;
        osm.setOpacity(opacity);
    };
    modifyIndexOSMLayerMin = function () {
        var cidx = osm.getZIndex();
        if (cidx === 0) {
            return;
        }
        osm.setZIndex(--cidx);
    };
    modifyIndexOSMLayerMax = function () {
        var cidx = osm.getZIndex();
        osm.setZIndex(++cidx);
    };
    document.getElementById("addVectorLayer").onclick = addVectorLayer;
    document.getElementById("addMapsLayer").onclick = addMapsLayer;
    document.getElementById("addOSMLayer").onclick = addOSMLayer;
    document.getElementById("addVTLayer").onclick = addVTLayer;
    document.getElementById("modifyVisibilityOSMLayer").onclick = modifyVisibilityOSMLayer;
    document.getElementById("modifyOpacityOSMLayer").onclick = modifyOpacityOSMLayer;
    document.getElementById("modifyIndexOSMLayerMin").onclick = modifyIndexOSMLayerMin;
    document.getElementById("modifyIndexOSMLayerMax").onclick = modifyIndexOSMLayerMax;
    document.getElementById("validateProducerTextOsm").onclick = (e) => {
        let input = document.getElementById("producerTextOsm");
        let text = input.value;

        console.log(osm)

        layerSwitcher.setLayerProducer(osm, text)
    }
</script>
{{/content}}

{{/extend}}